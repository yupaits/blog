# yutool-commons公共模块

yutool-commons是yutool组件式框架的基础模块，为yutool的各个组件和插件提供注解、常量、枚举等公共类，同时也扩展了接口返回码、业务异常定义、参数检查过程封装等功能。

这里对公共模块中扩展的特色功能进行简单的说明。

## 接口返回码

| 类名        | 说明                                                                                                                                                                                             | 核心属性及方法                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|-------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Result      | 响应结果封装类                                                                                                                                                                                   | • `String code;` 返回码 <br>• `String message;` 提示信息，终端用户使用 <br>• `String info;` 错误信息，开发者使用 <br>• `T data;` 返回数据 <br>• `boolean success;` 是否成功 <br>• `Result<T> ok();` 构造无数据的成功结果 <br>• `Result<T> ok(T data);` 构造有数据的成功结果 <br>• `Result<T> fail(IResultCode resultCode);` 根据响应枚举构造失败结果 <br>• `T checkAndGetRpcData(Result<T> result);` 作为远程调用返回结果的接收类型时，需要校验调用成功之后，再获取返回数据 |
| IResultCode | 响应码和响应语义枚举接口                                                                                                                                                                         | • `String getCode();` 获取响应码 <br>• `String getMessage();` 获取响应语义                                                                                                                                                                                                                                                                                                                                                                                              |
| ErrorCode   | 错误码枚举（参考[《Java开发手册(黄山版)》](https://github.com/alibaba/p3c/blob/master/Java%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C(%E9%BB%84%E5%B1%B1%E7%89%88).pdf)**附3：错误码列表**，实现IResultCode） |                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| ResultCode  | 响应码和响应语义枚举（实现IResultCode）                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |

## 业务异常定义

| 类名         | 说明                             | 核心属性及方法                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|--------------|--------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| BizException | 业务异常类（继承RuntimeException） | • `String code;` 错误码 <br>• `String message;` 错误信息 <br>• `ExpObject expObject;` 异常对象 <br>• `BizException of(String message);` 根据错误信息构建 <br>• `BizException of(Throwable cause);` 根据Throwable对象构建 <br>• `BizException of(String message, Throwable cause);` 根据错误信息和Throwable对象构建 <br>• `BizException of(IResultCode resultCode);` 根据IResultCode构建 <br>• `BizException of(IResultCode resultCode, Throwable cause);` 根据IResultCode和Throwable对象构建 <br>• `BizException args(Object... args);` 将message作为字符串模板，传入模板参数生成完整的message <br>• `BizException extraMsg(String extraMsg);` 拼接到message后的额外信息 <br>• `BizException expObject(ExpObject expObject);` 设置异常对象 |
| ExpObject    | 异常对象，按需灵活使用            | • `Object value;` 业务异常相关内容 <br>• `ExpObject of(Object object);` 异常对象构建方法                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |

## 参数检查过程

| 类名                 | 说明                             | 核心属性及方法                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|----------------------|--------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| IChecker             | 检查器接口                       | • `void check(CheckContext context);` 有上下文参数的检查 <br>• `void check();` 无上下文参数的检查                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| CheckContext         | 上下文参数接口                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| CheckProcedure       | 检查过程接口                     | • `void check(CheckContext context);` 有上下文参数的全面检查 <br>• `void check();` 无上下文参数的全面检查                                                                                                                                                                                                                                                                                                                                                                                                                         |
| ParamsChecker        | 参数检查器（实现IChecker）         | • `boolean condition;` 判断条件 <br>• `String message;` 参数错误提示信息 <br>• `void check();` 执行参数检查                                                                                                                                                                                                                                                                                                                                                                                                                       |
| ParamsCheckProcedure | 参数检查过程（实现CheckProcedure） | • `ParamsCheckProcedure procedure();` 创建参数校验过程 <br>• `void check();` 执行参数全面检查 <br>• `ParamsCheckProcedure add(boolean condition, String message);` 添加一个参数检查器 <br>• `ParamsCheckProcedure add(boolean condition, Supplier<String> messageSupplier);` 添加一个参数检查器 <br>• `ParamsCheckProcedure add(BooleanSupplier conditionSupplier, String message);` 添加一个参数检查器 <br>• `ParamsCheckProcedure add(BooleanSupplier conditionSupplier, Supplier<String> messageSupplier);` 添加一个参数检查器 |

## JSON序列化/反序列化

| 类名                | 说明                                                            |
|---------------------|---------------------------------------------------------------|
| JavaTimeModule      | Java8时间默认序列化模块，适配jackson                             |
| LongParamModule     | Long类型默认序列化模块，适配jackson                              |
| IdSerializer        | 解决Long类型的主键转json传回前端丢失精度的问题，将Long转成String |
| SensitiveSerializer | 信息脱敏                                                        |
| LongDeserializer    | SQL注入过滤                                                     |
| XssDeserializer     | XSS过滤                                                         |

## 特定场景编程范式

| 类名                    | 说明                                                                                          | 核心属性及方法                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|-------------------------|---------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| BatchDataRefresher      | 批量数据刷新器：将待更新的数据与已经持久化的数据按业务主键维度对比后执行批量新增、更新、删除操作 | • `Map<K, T> persistedDataMap;` 已经持久化的数据Map <br>• `Map<K, T> dataMap;` 待更新的数据Map <br>• `Function<T, K> keyMapper;` 数据主键转换器 <br>• `Consumer<Collection<T>> batchSaveHandler;` 批量新增处理器 <br>• `Consumer<Collection<T>> batchUpdateHandler;` 批量更新处理器 <br>• `Consumer<Collection<T>> batchDeleteHandler;` 批量删除处理器 <br>• `Comparator<T> comparator;` 新增数据排序比较器 <br>• `BatchDataRefresher<T, K> of(Function<T, K> keyMapper, Consumer<Collection<T>> batchSaveHandler, Consumer<Collection<T>> batchUpdateHandler, Consumer<Collection<T>> batchDeleteHandler);` 构建批量数据刷新器 <br>• `BatchDataRefresher<T, K> of(Function<T, K> keyMapper, Consumer<Collection<T>> batchSaveHandler, Consumer<Collection<T>> batchUpdateHandler, Consumer<Collection<T>> batchDeleteHandler, Comparator<T> comparator);` 构建批量数据刷新器 <br>• `void putPersistedData(Collection<T> collection);` 放置持久化的数据集合 <br>• `void putPersistedData(T... data);` 放置持久化的数据 <br>• `void putData(Collection<T> collection);` 放置待更新数据集合 <br>• `void putData(T... data);` 放置待更新数据 <br>• `void batchRefresh(BinaryOperator<T> updater);` 批量刷新数据 |
| Evaluate                | 求值器，可用于替换if-elseif-else赋值语句和switch-case-default赋值语句                          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| MultiLevelValueSearcher | 多层级匹配取值器                                                                              | • `List<Supplier<Q>> queries;` 多层级匹配条件 <br>• `Function<Q, T> searcher;` 取值器 <br>• `T defaultValue;` 默认值 <br>• `MultiLevelValueSearcher<Q, T> of(List<Supplier<Q>> queries, Function<Q, T> searcher, T defaultValue);` 构架多层级匹配取值器 <br>• `T matchAndGet();` 执行匹配并获取结果 <br>• `T matchAndGet(Predicate<T> predicate);` 执行匹配并获取通过指定标准验收的结果                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| RatioMap                | 占比Map                                                                                       | • `Map<K, BigDecimal> volumeMap;` 数量分布Map <br>• `BigDecimal totalVolume = TOTAL_PERCENT;` 总量（默认100） <br>• `RatioMap<K> create(Supplier<Map<K, BigDecimal>> supplier);` 创建一个总量为100的数量分布Map <br>• `RatioMap<K> create(Supplier<Map<K, BigDecimal>> supplier, BigDecimal totalVolume);` 创建一个指定总量的数量分布Map <br>• `Map<K, BigDecimal> getRatios();` 计算得到一个百分比分布Map <br>• `Map<K, BigDecimal> toMakeUpRatioMap(Integer scale);` 将百分比差值补足到最大占比上，指定百分比数值保留几位小数 <br>• `Map<K, BigDecimal> toMakeUpRatioMapByProportion(Integer scale);` 按原占比等比例补足百分比差值，指定百分比数值保留几位小数                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| RecordableRateLimiter   | 可记录的限流器                                                                                | • `String name;` 调用过程名称 <br>• `double initialRateLimit;` 初始限流速率（每秒） <br>• `AtomicLong globalCallCount = new AtomicLong();` 全局总调用次数 <br>• `RateLimiter rateLimiter;` 限流器 <br>• `AtomicLong lastTimeCallCount;` 本次任务开始时记录的上次任务结束时总调用次数 <br>• `long recordRate = 10L;` 记录间隔时间（秒） <br>• `AtomicLong previousCallCount;` 上次记录时的调用次数 <br>• `void process(Runnable runnable);` 开始执行任务 <br>• `R invoke(T params);` 执行调用过程 <br>• `R call(T params);` 实际调用过程 <br>• `void setRateLimit(double rateLimit);` 设置限流速率 <br>• `void startRecord();` 开始记录 <br>• `void stopRecord();` 停止记录 <br>• `long getTaskCallCount();` 获取此次任务开始时截至当前时刻的总调用次数                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| Switch                  | switch语句的lambda实现                                                                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |