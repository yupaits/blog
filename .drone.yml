kind: pipeline
type: docker
name: 构建站点文件

clone:
  git:
    image: alpine/git
    commands:
      - git config --global credential.helper "store --file=/tmp/git-credentials"
      - echo "https://yupaits:ts7649389@gitea.yupaits.com" > /tmp/git-credentials
      - git clone https://gitea.yupaits.com/yupaits/blog-md.git .

steps:
  - name: pnpm构建
    image: node:18-alpine
    volumes:
      - name: cache
        path: /.pnpm-store
      - name: dist
        path: /drone/src/docs/.vitepress/dist
    commands:
      - cat /etc/apk/repositories
      - echo -e 'http://mirrors.ustc.edu.cn/alpine/v3.20/main\nhttp://mirrors.ustc.edu.cn/alpine/v3.20/community' > /etc/apk/repositories
      - apk update && apk add git
      - git version
      - npm config set registry https://registry.npmmirror.com
      - npm install -g corepack@latest
      - corepack enable
      - npx pnpm config set store-dir /.pnpm-store
      - npx pnpm config set registry https://registry.npmmirror.com
      - npx pnpm install --shamefully-hoist
      - npx pnpm run docs:build

volumes:
  - name: cache
    host:
      path: /volume1/docker/drone/pnpm/cache
  - name: dist
    host:
      path: /volume1/docker/drone/yupaits-notes