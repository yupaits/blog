kind: pipeline
type: docker
name: 构建站点文件

steps:
  - name: pnpm构建
    image: node:18-alpine
    volumes:
      - name: cache
        path: /.pnpm-store
      - name: dist
        path: /drone/src/docs/.vitepress/dist
    commands:
      - cat /etc/apk/repositories
      - echo -e 'http://mirrors.jcut.edu.cn/alpine/v3.20/main\nhttp://mirrors.jcut.edu.cn/alpine/v3.20/community' > /etc/apk/repositories
      - apk update && apk add git
      - git version
      - npm install -g corepack@latest
      - corepack enable
      - npx pnpm config set store-dir /.pnpm-store
      - npx pnpm config set registry https://registry.npmmirror.com
      - npx pnpm install --shamefully-hoist
      - npx pnpm run docs:build
  - name: 构建Docker镜像
    image: docker:dind
    volumes:
      - name: dockersock
        path: /var/run
      - name: dist
        path: /drone/src/docs/.vitepress/dist
      - name: docker-images
        path: /docker/images
    commands:
      # - docker stop yupaits-notes
      # - docker rm yupaits-notes
      # - docker rmi yupaits-notes:latest
      - docker build -f Dockerfile . -t yupaits-notes:1.0.0 -t yupaits-notes:latest
      - docker save -o /docker/images/yupaits-notes-1.0.0.tar yupaits-notes:1.0.0
      - docker run -d --restart=always --name yupaits-notes -p 8888:80 yupaits-notes:latest

volumes:
  - name: cache
    host:
      path: /root/drone/pnpm/cache
  - name: ui-dist
    temp: { }
  - name: dockersock
    host:
      path: /var/run
  - name: docker-images
    host:
      path: /root/drone/docker/images